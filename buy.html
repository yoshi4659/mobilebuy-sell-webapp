<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ç‡∏≤‡∏¢‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
    label { margin-top: 10px; display: block; }
    button { background: #4CAF50; color: white; border: none; border-radius: 4px; }
    button:hover { background: #45a049; }
  </style>
</head>
<body>

  <h2>üì± ‡∏Ç‡∏≤‡∏¢‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á</h2>

  <label>üîç ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç IMEI ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô:</label>
  <input type="text" id="imeiInput" oninput="searchIMEI()" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏´‡∏•‡∏±‡∏Å">

  <label>üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IMEI ‡∏ó‡∏µ‡πà‡∏û‡∏ö:</label>
  <select id="imeiResults" onchange="fillFormFromSelection()">
    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IMEI --</option>
  </select>

  <label>üìå ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
  <input id="brand" readonly>

  <label>üìå ‡∏£‡∏∏‡πà‡∏ô</label>
  <input id="model" readonly>

  <label>üì¶ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</label>
  <input id="storage" readonly>

  <label>üß© ‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
  <input id="condition" readonly>

  <label>‚ö†Ô∏è ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥</label>
  <input id="defect" readonly>

  <label>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</label>
  <input id="buyPrice" readonly>

  <label>üí∏ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
  <input id="sellPrice">

  <label>üë§ ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
  <input id="buyer">

  <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
  <input id="note">

  <input type="hidden" id="rowIndex">

  <button onclick="submitData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button onclick="goHome()">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>

  <script>
    const scriptURL = 'https://mobilebuy-sell-webapp-1.onrender.com';


    async function searchIMEI() {
      const imeiText = document.getElementById("imeiInput").value.trim();
      console.log("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI:", imeiText);
      const resultBox = document.getElementById("imeiResults");
      resultBox.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... --</option>';

      if (imeiText.length < 3) {
        resultBox.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß --</option>';
        return;
      }
       
      try {
        const res = await fetch(`${scriptURL}?imei=${imeiText}`);
        const text = await res.text();
        console.log("üì¶ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å API:", text); 

        if (text === "Not found" || text.trim() === "") {
          resultBox.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>';
          return;
        }

        let data = JSON.parse(text);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏™‡∏°‡∏≠
        if (!Array.isArray(data)) {
          data = [data];
        }

        resultBox.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IMEI --</option>';
        data.forEach(item => {
          resultBox.innerHTML += `<option value='${JSON.stringify(item)}'>${item.IMEI}</option>`;
        });

      } catch (err) {
        console.error(err);
        resultBox.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
      }
    }

  function fillFormFromSelection() {
  const selected = document.getElementById("imeiResults").value;
  if (!selected) return;

  const raw = JSON.parse(selected); // <== ‡πÄ‡∏≠‡∏≤ decodeURIComponent ‡∏≠‡∏≠‡∏Å
  const data = cleanKeys(raw); 
  
  document.getElementById("brand").value = data["‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠"] || "";
  document.getElementById("model").value = data["‡∏£‡∏∏‡πà‡∏ô"] || "";
  document.getElementById("storage").value = data["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏"] || "";
  document.getElementById("condition").value = data["‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("defect").value = data["‡∏ï‡∏≥‡∏´‡∏ô‡∏¥"] || "";
  document.getElementById("buyPrice").value = data["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠"] || "";
  document.getElementById("rowIndex").value = data["rowIndex"];
  document.getElementById("imeiInput").value = data["IMEI"];
}
function cleanKeys(obj) {
  const cleaned = {};
  for (const key in obj) {
    cleaned[key.trim()] = obj[key];
  }
  return cleaned;
}


    async function submitData() {
      const rowIndex = document.getElementById("rowIndex").value;
      const imei = document.getElementById("imeiInput").value;
      const brand = document.getElementById("brand").value;
      const model = document.getElementById("model").value;
      const storage = document.getElementById("storage").value;
      const condition = document.getElementById("condition").value;
      const defect = document.getElementById("defect").value;
      const buyPrice = document.getElementById("buyPrice").value;
      const sellPrice = document.getElementById("sellPrice").value;
      const buyer = document.getElementById("buyer").value;
      const note = document.getElementById("note").value;
      const sellDate = new Date().toLocaleString("th-TH");

      if (!rowIndex || !sellPrice || !buyer) {
        alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        return;
      }

      if (parseFloat(sellPrice) < parseFloat(buyPrice)) {
        alert("‚ö†Ô∏è ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
        return;
      }

      const payload = {
        rowIndex,
        imei,
        brand,
        model,
        storage,
        condition,
        defect,
        buyPrice,
        sellPrice,
        buyer,
        note,
        sellDate
      };

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });

        const result = await res.text();
        alert("‚úÖ " + result);
        window.location.reload();
      } catch (err) {
        alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        console.error(err);
      }
    }

    function goHome() {
      window.location.href = "index.html";
    }
  </script>

</body>
</html>
